rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Predictions collection rules
    match /predictions/{predictionId} {
      // Allow anyone to read predictions (for admin dashboard)
      allow read: if true;
      
      // Allow creation only with valid data
      allow create: if request.resource.data.name is string
                    && request.resource.data.enrollmentNumber is string
                    && request.resource.data.prediction is map
                    && request.resource.data.prediction.realMadridScore is number
                    && request.resource.data.prediction.barcelonaScore is number
                    && request.resource.data.prediction.winner is string
                    && request.resource.data.timestamp != null
                    // Prevent duplicate enrollment numbers (checked in app logic)
                    && request.resource.data.enrollmentNumber.size() > 0;
      
      // Never allow updates or deletes (predictions are permanent)
      allow update: if false;
      allow delete: if false;
    }
    
    // ─── Diary Profiles ────────────────────────────────────────
    match /diary_profiles/{userId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }

    // ─── Diary Posts ───────────────────────────────────────────
    match /diary_posts/{postId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null
                    && resource.data.authorId == request.auth.uid;
      allow delete: if request.auth != null
                    && resource.data.authorId == request.auth.uid;
    }

    // ─── Diary Follows ────────────────────────────────────────
    match /diary_follows/{followId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow delete: if request.auth != null
                    && resource.data.followerId == request.auth.uid;
    }

    // ─── Diary Likes ──────────────────────────────────────────
    match /diary_likes/{likeId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow delete: if request.auth != null
                    && resource.data.userId == request.auth.uid;
    }

    // ─── Diary Comments ───────────────────────────────────────
    match /diary_comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null
                    && resource.data.authorId == request.auth.uid;
      allow delete: if request.auth != null
                    && resource.data.authorId == request.auth.uid;
    }

    // ─── Diary Bookmarks ──────────────────────────────────────
    match /diary_bookmarks/{bookmarkId} {
      allow read: if request.auth != null
                  && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
      allow delete: if request.auth != null
                    && resource.data.userId == request.auth.uid;
    }

    // ─── Diary Subscriptions ──────────────────────────────────
    match /diary_subscriptions/{subId} {
      allow read: if true;
      allow create: if true; // Allow even unauthenticated email subscriptions
      allow update: if true; // Allow unsubscribe via token
      allow delete: if false;
    }

    // ─── Diary Notifications ──────────────────────────────────
    match /diary_notifications/{notifId} {
      allow read: if request.auth != null
                  && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
      allow update: if request.auth != null
                    && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }

    // ─── Diary Reports ────────────────────────────────────────
    match /diary_reports/{reportId} {
      allow read: if false; // Only admin via server SDK
      allow create: if request.auth != null;
      allow update: if false;
      allow delete: if false;
    }

    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
